# overwrite the default version scheme - we have our own set in MsBuild
version: '{build}'

image: Visual Studio 2017

cache:
  - AudioAnalysis\packages -> **\packages.config
  # cache the lfs objects directory so that git-lfs does not always download a
  # full set of blobs (saves bandwidth)
  - '.git\lfs\objects'

matrix:
  fast_finish: true
  
platform:
  - Any CPU

configuration:
  - Debug
  - Release

# Attempt to limit the number of commits to clone - our project has a LOT of history
# TODO: drop this to about ~100 later on
clone_depth: 200

environment:
  # Disable git-lfs to give appveyor a chance to overlay the cache files onto the repo
  GIT_LFS_SKIP_SMUDGE: 1

# Before the clone occurs
init:
  - ps: iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
  #- git lfs install --skip-smudge

before_build:
  # Download fresh lfs assets
  - git lfs pull
  # Restore packages 
  - cd AudioAnalysis
  - nuget restore

build_script:
  - ps: >
      msbuild 
      "C:\projects\audio-analysis\AudioAnalysis\AudioAnalysis2012.sln" /m /verbosity:minimal 
      /logger:"C:\Program Files\AppVeyor\BuildAgent\Appveyor.MSBuildLogger.dll"
      /p:WarningLevel=0 /p:RunCodeAnalysis=false
      /p:Configuration=$env:configuration /property:Platform=$env:platform

test:
  assemblies:
    only:
      #- "C:\Work\Github\audio-analysis\Acoustics\Acoustics.Test\bin\Debug\Acoustics.Test.dll"
      #- "C:\Work\Github\audio-analysis\AudioAnalysis\AED\Test\bin\Debug\Test.dll"
      - '**\Acoustics.Test.dll'

on_finish:
  - ps: $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
